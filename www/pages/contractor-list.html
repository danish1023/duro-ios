<template>
  <div class="page" id="contractor-list-page">
    <div class="navbar">
      <div class="navbar-inner sliding bg-color-red color-theme-white">
        <div class="left">
          <a href="#" class="link back">
            <i class="material-icons">arrow_back</i>
          </a>
        </div>
        <div class="title color-white">Mapped Contractors</div>
        <div class="right">
          <a class="link icon-only searchbar-enable" data-searchbar=".searchbar-contractor">
            <i class="icon material-icons md-only">search</i>
          </a>
        </div>
        <form class="searchbar searchbar-expandable searchbar-contractor searchbar-init">
          <div class="searchbar-inner">
            <div class="searchbar-input-wrap">
              <input @keydown="checkLength" @keyup="checkLength" type="search" placeholder="Mobile Number">
              <i class="searchbar-icon"></i>
              <span class="input-clear-button"></span>
            </div>
            <span class="searchbar-disable-button">Cancel</span>
          </div>
        </form>
      </div>
    </div>
    <div class="page-content bg-color-white">

    </div>
  </div>
</template>
<script>
  return {
    on: {
      pageInit: function (e, page) {
        var User = localStorage.User;
        var UserData = JSON.parse(User);
        var obj = {
          UserName: UserData.MembershipId,
        };
        app.request({
          url: BaseURL + '/ListContractorAPI',
          method: 'POST',
          dataType: 'json',
          data: obj,
          contentType: 'application/json',
          beforeSend: function (xhr) {
            xhr.setRequestHeader("Authorization", "Basic " + btoa(AuthUsername + ":" + AuthPassword));
            var spinnerOptions = { dimBackground: false };
            SpinnerPlugin.activityStart(null, spinnerOptions);
          },
          error: function (xhr, status) {
            alert("Error: " + status);
          },
          success: function (data, status, xhr) {
            if (data.ErrorCode == '0') {
              var TotalMappedContractors = data.TotalMappedContractors;
              var ActiveMappedContractors = data.ActiveMappedContractors;
              var InActiveMappedContractors = data.InActiveMappedContractors;
              var ContractorListDetails = data.Response.ContractorListDetails;
              if (ContractorListDetails) {
                var tbody_active = '';
                var tbody_inactive = '';
                for (var i = 0; i < ContractorListDetails.length; i++) {
                  var ContractorName = ContractorListDetails[i].ContractorName;
                  var ContractorMobileNo = ContractorListDetails[i].ContractorMobileNo;
                  var ContractorPoints = ContractorListDetails[i].ContractorPoints;
                  var ContractorStatus = ContractorListDetails[i].ContractorStatus;
                  var tbody_el = `
                    <tr>
                      <td class="label-cell"><a href="/contractor-details/${ContractorMobileNo}/">${ContractorName}</a></td>
                      <td class="label-cell">${ContractorMobileNo}</td>
                      <td class="label-cell">${ContractorPoints}</td>
                    </tr>`;
                  if (ContractorStatus == 'Yes') {
                    tbody_active = tbody_active + tbody_el;
                  }
                  else {
                    tbody_inactive = tbody_inactive + tbody_el;
                  }
                }
              }
              var html = `
              <div class="list no-hairlines accordion-list margin-top">
                <ul>
                  <li class="accordion-item">
                    <div class="item-content">
                      <div class="item-inner">
                        <div class="item-title">Enrolled Members</div>
                        <div class="item-after" style="padding-right: 26px">${TotalMappedContractors}</div>
                      </div>
                    </div>
                  </li>
                  <li class="accordion-item">
                    <a href="#" class="item-link item-content">
                      <div class="item-inner">
                        <div class="item-title">Active Members</div>
                        <div class="item-after">${ActiveMappedContractors}</div>
                      </div>
                    </a>
                    <div class="accordion-item-content active-dealers">
                        <div class="data-table">
                          <table>
                            <thead>
                                <tr>
                                  <th class="label-cell color-red">Contractor Name</th>
                                  <th class="label-cell color-red">Contractor Mobile</th>
                                  <th class="label-cell color-red">Contractor Points</th>
                                </tr>
                            </thead>
                            <tbody>
                              ${tbody_active}
                            </tbody>
                          </table>
                        </div>
                    </div>
                  </li>
                  <li class="accordion-item">
                    <a href="#" class="item-link item-content">
                      <div class="item-inner">
                        <div class="item-title">Inactive Members</div>
                        <div class="item-after">${InActiveMappedContractors}</div>
                      </div>
                    </a>
                    <div class="accordion-item-content inactive-dealers">
                        <div class="data-table">
                          <table>
                            <thead>
                                <tr>
                                  <th class="label-cell color-red">Contractor Name</th>
                                  <th class="label-cell color-red">Contractor Mobile</th>
                                  <th class="label-cell color-red">Contractor Points</th>
                                </tr>
                            </thead>
                            <tbody>
                              ${tbody_inactive}
                            </tbody>
                          </table>
                        </div>
                    </div>
                  </li>
                </ul>
              </div>`;
              $$('#contractor-list-page .page-content').html(html);
            }
            else {
              app.dialog.alert(data.ErrorMessage);
            }
          },
          complete: function (xhr, status) {
            SpinnerPlugin.activityStop();
          }
        })
      },
      pageReinit: function(e,page){
        app.searchbar.disable('.searchbar');
      }
    },
    methods: {
      checkLength: function () {
        var MobileNo = $$('#contractor-list-page input[type=search]').val();
        if (MobileNo.length == 10) {
          app.router.navigate({
            name: 'contractor-details',
            params: { 'ContractorMobileNo': MobileNo },
          });
        }
      }
    }
  }
</script>